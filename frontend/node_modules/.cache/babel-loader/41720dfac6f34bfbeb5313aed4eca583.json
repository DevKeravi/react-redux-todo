{"ast":null,"code":"import { call, cancelled, put, take, takeEvery } from \"redux-saga/effects\";\nimport { END, eventChannel } from \"redux-saga\";\nimport createWebSocketConnection from \"../webSocket/socket\";\nimport { ADD_MSG, CONNECT_SOCKET, SOCKET_CONNECTION_ERROR, SOCKET_CONNECTION_SUCCESS } from \"../modules/chat\";\n\nfunction createEventChannel(socket) {\n  return eventChannel(emit => {\n    socket.onmessage = event => {\n      console.log(event.data);\n      emit(event.data);\n    };\n\n    socket.onclose = () => {\n      emit(END);\n    };\n\n    const unsubscribe = () => {\n      socket.onmessage = null;\n    };\n\n    return unsubscribe;\n  });\n}\n\nfunction* listenForSocketMessages() {\n  let socket;\n  let socketChannel;\n\n  try {\n    socket = yield call(createWebSocketConnection);\n    socketChannel = yield call(createEventChannel, socket);\n    yield put(SOCKET_CONNECTION_SUCCESS(socket));\n\n    while (true) {\n      const payload = yield take(socketChannel);\n\n      switch (payload.type) {\n        case \"added\":\n          return;\n\n        default:\n          return;\n      }\n    }\n  } catch (e) {\n    console.log(e);\n    yield put(SOCKET_CONNECTION_ERROR(e));\n  } finally {\n    if (yield cancelled()) {\n      socketChannel.close();\n      socket.close();\n    } else {\n      yield put(SOCKET_CONNECTION_ERROR(\"WebSocket disconnected\"));\n    }\n  }\n}\n\nexport function* connectWebSocket() {\n  yield takeEvery(CONNECT_SOCKET, listenForSocketMessages); //DISCONNECT TODO\n\n  /*\n  yield take(SOCKET_DISCONNECT);\n  yield cancel(socketTask);\n  yield put(SOCKET_DISCONNECT_SUCCESS);\n  */\n}","map":{"version":3,"sources":["/home/cmkrosp/go/src/react-redux-todo/frontend/src/saga/webSocketSaga.js"],"names":["call","cancelled","put","take","takeEvery","END","eventChannel","createWebSocketConnection","ADD_MSG","CONNECT_SOCKET","SOCKET_CONNECTION_ERROR","SOCKET_CONNECTION_SUCCESS","createEventChannel","socket","emit","onmessage","event","console","log","data","onclose","unsubscribe","listenForSocketMessages","socketChannel","payload","type","e","close","connectWebSocket"],"mappings":"AAAA,SAASA,IAAT,EAAeC,SAAf,EAA0BC,GAA1B,EAA+BC,IAA/B,EAAqCC,SAArC,QAAsD,oBAAtD;AACA,SAASC,GAAT,EAAcC,YAAd,QAAkC,YAAlC;AACA,OAAOC,yBAAP,MAAsC,qBAAtC;AACA,SACEC,OADF,EAEEC,cAFF,EAGEC,uBAHF,EAIEC,yBAJF,QAKO,iBALP;;AAOA,SAASC,kBAAT,CAA4BC,MAA5B,EAAoC;AAClC,SAAOP,YAAY,CAAEQ,IAAD,IAAU;AAC5BD,IAAAA,MAAM,CAACE,SAAP,GAAoBC,KAAD,IAAW;AAC5BC,MAAAA,OAAO,CAACC,GAAR,CAAYF,KAAK,CAACG,IAAlB;AACAL,MAAAA,IAAI,CAACE,KAAK,CAACG,IAAP,CAAJ;AACD,KAHD;;AAIAN,IAAAA,MAAM,CAACO,OAAP,GAAiB,MAAM;AACrBN,MAAAA,IAAI,CAACT,GAAD,CAAJ;AACD,KAFD;;AAIA,UAAMgB,WAAW,GAAG,MAAM;AACxBR,MAAAA,MAAM,CAACE,SAAP,GAAmB,IAAnB;AACD,KAFD;;AAGA,WAAOM,WAAP;AACD,GAbkB,CAAnB;AAcD;;AAED,UAAUC,uBAAV,GAAoC;AAClC,MAAIT,MAAJ;AACA,MAAIU,aAAJ;;AAEA,MAAI;AACFV,IAAAA,MAAM,GAAG,MAAMb,IAAI,CAACO,yBAAD,CAAnB;AACAgB,IAAAA,aAAa,GAAG,MAAMvB,IAAI,CAACY,kBAAD,EAAqBC,MAArB,CAA1B;AAEA,UAAMX,GAAG,CAACS,yBAAyB,CAACE,MAAD,CAA1B,CAAT;;AAEA,WAAO,IAAP,EAAa;AACX,YAAMW,OAAO,GAAG,MAAMrB,IAAI,CAACoB,aAAD,CAA1B;;AACA,cAAQC,OAAO,CAACC,IAAhB;AACE,aAAK,OAAL;AACE;;AACF;AACE;AAJJ;AAMD;AACF,GAfD,CAeE,OAAOC,CAAP,EAAU;AACVT,IAAAA,OAAO,CAACC,GAAR,CAAYQ,CAAZ;AACA,UAAMxB,GAAG,CAACQ,uBAAuB,CAACgB,CAAD,CAAxB,CAAT;AACD,GAlBD,SAkBU;AACR,QAAI,MAAMzB,SAAS,EAAnB,EAAuB;AACrBsB,MAAAA,aAAa,CAACI,KAAd;AACAd,MAAAA,MAAM,CAACc,KAAP;AACD,KAHD,MAGO;AACL,YAAMzB,GAAG,CAACQ,uBAAuB,CAAC,wBAAD,CAAxB,CAAT;AACD;AACF;AACF;;AAED,OAAO,UAAUkB,gBAAV,GAA6B;AAClC,QAAMxB,SAAS,CAACK,cAAD,EAAiBa,uBAAjB,CAAf,CADkC,CAGlC;;AACA;AACF;AACA;AACA;AACA;AACC","sourcesContent":["import { call, cancelled, put, take, takeEvery } from \"redux-saga/effects\";\nimport { END, eventChannel } from \"redux-saga\";\nimport createWebSocketConnection from \"../webSocket/socket\";\nimport {\n  ADD_MSG,\n  CONNECT_SOCKET,\n  SOCKET_CONNECTION_ERROR,\n  SOCKET_CONNECTION_SUCCESS,\n} from \"../modules/chat\";\n\nfunction createEventChannel(socket) {\n  return eventChannel((emit) => {\n    socket.onmessage = (event) => {\n      console.log(event.data);\n      emit(event.data);\n    };\n    socket.onclose = () => {\n      emit(END);\n    };\n\n    const unsubscribe = () => {\n      socket.onmessage = null;\n    };\n    return unsubscribe;\n  });\n}\n\nfunction* listenForSocketMessages() {\n  let socket;\n  let socketChannel;\n\n  try {\n    socket = yield call(createWebSocketConnection);\n    socketChannel = yield call(createEventChannel, socket);\n\n    yield put(SOCKET_CONNECTION_SUCCESS(socket));\n\n    while (true) {\n      const payload = yield take(socketChannel);\n      switch (payload.type) {\n        case \"added\":\n          return;\n        default:\n          return;\n      }\n    }\n  } catch (e) {\n    console.log(e);\n    yield put(SOCKET_CONNECTION_ERROR(e));\n  } finally {\n    if (yield cancelled()) {\n      socketChannel.close();\n      socket.close();\n    } else {\n      yield put(SOCKET_CONNECTION_ERROR(\"WebSocket disconnected\"));\n    }\n  }\n}\n\nexport function* connectWebSocket() {\n  yield takeEvery(CONNECT_SOCKET, listenForSocketMessages);\n\n  //DISCONNECT TODO\n  /*\n  yield take(SOCKET_DISCONNECT);\n  yield cancel(socketTask);\n  yield put(SOCKET_DISCONNECT_SUCCESS);\n  */\n}\n"]},"metadata":{},"sourceType":"module"}